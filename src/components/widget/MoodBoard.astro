---
import { getCollection } from "astro:content";

// 1. è·å–æ–‡ç« 
const allPosts = await getCollection("posts");
// è¿‡æ»¤æ‰è‰ç¨¿å’Œæœªå‘å¸ƒçš„æ–‡ç« (å¯é€‰ï¼Œè§†ä½ çš„éœ€æ±‚è€Œå®š)
const validPosts = allPosts.filter(p => !p.data.draft); 

// 2. é¢œè‰²é…ç½®
const moodColors: Record<string, string> = {
    excellent: "bg-green-400 dark:bg-green-500",
    normal: "bg-blue-400 dark:bg-blue-500",
    bad: "bg-red-400 dark:bg-red-500",
    empty: "bg-gray-100 dark:bg-gray-700/50",
};

// 3. ç”Ÿæˆæ—¥æœŸ (æœ€è¿‘28å¤©)
const daysToShow = 28;
const today = new Date();
today.setHours(0, 0, 0, 0);

const dateList = Array.from({ length: daysToShow }, (_, i) => {
    const d = new Date(today);
    d.setDate(d.getDate() - (daysToShow - 1 - i));
    return d;
});

// 4. è¾…åŠ©å‡½æ•° (å·²ä¿®å¤é€»è¾‘)
function getMoodForDate(_date: Date) {
    const targetDateStr = _date.toDateString();
    
    const post = validPosts.find((p) => {
        const postDate = new Date(p.data.published);
        // æ¯”è¾ƒæ—¥æœŸå­—ç¬¦ä¸²ï¼Œå¿½ç•¥å…·ä½“æ—¶åˆ†ç§’
        const isSameDay = postDate.toDateString() === targetDateStr;
        // ç¡®ä¿æ–‡ç« æœ‰ mood å­—æ®µ
        const hasMood = (p.data as any).mood !== undefined;
        return isSameDay && hasMood;
    });

    return post ? (post.data as any).mood : null;
}
---

<div class="card-base px-4 py-4 border-none !bg-white/50 dark:!bg-black/5 mb-4">
    <div class="font-bold text-lg mb-3 text-neutral-900 dark:text-neutral-100 flex items-center gap-2">
        <span>ğŸ“Š</span> æ¯æ—¥çŠ¶æ€
    </div>

    <div class="grid grid-cols-7 gap-2">
        {dateList.map((date) => {
            const mood = getMoodForDate(date);
            // å¦‚æœæ²¡æœ‰ moodï¼Œä½¿ç”¨ empty
            const colorClass = mood ? (moodColors[mood as string] || moodColors.normal) : moodColors.empty;
            const isToday = date.toDateString() === today.toDateString();

            const baseClass = `
                aspect-square rounded-sm transition-all duration-300
                ${colorClass}
                ${isToday ? 'ring-2 ring-black/20 dark:ring-white/20' : ''}
                relative group flex items-center justify-center
                cursor-default
            `;

            return (
                <div class={baseClass}>
                    {/* Tooltip æ‚¬æµ®æç¤ºæ¡† */}
                    <span class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-2 py-1 text-[10px] text-white bg-black/80 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none z-10">
                        {date.toLocaleDateString()} {mood ? `- ${mood}` : ''}
                    </span>
                </div>
            );
        })}
    </div>

    {/* åº•éƒ¨å›¾ä¾‹ */}
    <div class="flex justify-between items-center mt-3 text-xs text-gray-400">
        <a href="/archive/tag/bad" class="flex items-center gap-1 hover:text-red-500 transition-colors"><span class="w-2 h-2 rounded-full bg-red-400"></span>å</a>
        <a href="/archive/tag/normal" class="flex items-center gap-1 hover:text-blue-500 transition-colors"><span class="w-2 h-2 rounded-full bg-blue-400"></span>å¸¸</a>
        <a href="/archive/tag/excellent" class="flex items-center gap-1 hover:text-green-500 transition-colors"><span class="w-2 h-2 rounded-full bg-green-400"></span>ä¼˜</a>
    </div>
</div>